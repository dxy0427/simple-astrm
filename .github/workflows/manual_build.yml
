name: æ‰‹åŠ¨æ„å»º simple-astrm é•œåƒåˆ° GHCR

on:
  workflow_dispatch:
    inputs:
      image-tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆé»˜è®¤ï¼šlatestï¼‰'
        required: false
        default: 'latest'

jobs:
  build-and-push-ghcr:
    runs-on: ubuntu-latest
    permissions:
      packages: write  # å…è®¸æ¨é€é•œåƒåˆ°GHCR
      contents: read   # å…è®¸è¯»å–ä»“åº“ä»£ç 
    steps:
      - name: æ£€æŸ¥ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æå–é•œåƒæ ‡ç­¾
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.actor }}/simple-astrm  # é•œåƒåä¸é¡¹ç›®åä¸€è‡´
          tags: |
            ${{ github.event.inputs.image-tag }}
            ${{ github.sha }}  # ç”¨commitå“ˆå¸Œåšç‰ˆæœ¬æ ‡ç­¾
          flavor: |
            latest=${{ github.event.inputs.image-tag == 'latest' }}

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .  # æ„å»ºä¸Šä¸‹æ–‡ï¼šé¡¹ç›®æ ¹ç›®å½•
          file: ./Dockerfile  # æ­£ç¡®çš„Dockerfileè·¯å¾„
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64  # å•ä¸€æ„å»ºå¹³å°
          cache-from: type=gha  # ç¼“å­˜åŠ é€Ÿ
          cache-to: type=gha,mode=max

      - name: è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "âœ… é•œåƒæ„å»ºæ¨é€å®Œæˆï¼"
          echo "ğŸ“¦ é•œåƒåœ°å€ï¼š${{ steps.meta.outputs.tags }}"
          echo "ğŸ’¡ æ‹‰å–å‘½ä»¤ï¼šdocker pull ghcr.io/${{ github.actor }}/simple-astrm:${{ github.event.inputs.image-tag }}"
          echo "ğŸŸ¢ è¿è¡Œå‘½ä»¤ï¼šdocker run -d -p 8095:8095 -v \$(pwd)/config.yaml:/app/config.yaml --restart always ghcr.io/${{ github.actor }}/simple-astrm:${{ github.event.inputs.image-tag }}"